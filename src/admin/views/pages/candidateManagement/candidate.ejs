<!-- Bootstrap + FontAwesome + DataTable CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet">

<style>
    .btn-pink {
        background-color: #e91e63;
        color: white;
    }

    .btn-pink:hover {
        background-color: #c2185b;
    }

    .table th,
    .table td {
        vertical-align: middle;
        text-align: center;
    }

    .modal-title {
        font-weight: bold;
    }
</style>

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold">ðŸ‘¥ Candidate Management</h3>
    </div>
    <div class="card shadow-sm mb-4" id="searchBackendUsersCard">
        <div class="card-body">
            <h5 class="mb-3">Search Candidate User</h5>
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="searchName" class="form-label">Name</label>
                    <input type="text" class="form-control" id="searchName" placeholder="Enter Name">
                </div>
                <div class="col-md-3">
                    <label for="searchEmail" class="form-label">Email</label>
                    <input type="text" class="form-control" id="searchEmail" placeholder="Enter Email">
                </div>
                <div class="col-md-3">
                    <label for="searchGender" class="form-label">Gender</label>
                    <select id="searchGender" class="form-select">
                        <option value="">All</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="searchEducation" class="form-label">Education</label>
                    <select id="searchEducation" class="form-select">
                        <option value="">All</option>
                        <option value="Class X">Class X</option>
                        <option value="Class XII">Class XII</option>
                        <option value="Graduation">Graduation</option>
                        <option value="Post Graduation">Post Graduation</option>
                        <option value="Doctorate">Doctorate</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="searchWorkStatus" class="form-label">Work Status</label>
                    <select id="searchWorkStatus" class="form-select">
                        <option value="">All</option>
                        <option value="Fresher">Fresher</option>
                        <option value="Experienced">Experienced</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <div>
                        <label class="d-block" for="">&nbsp;</label>
                        <div class="mt-2">
                            <button class="btn btn-primary" id="searchBtn">Search</button>
                            <button class="btn btn-secondary" id="resetBtn">Reset</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="card shadow-sm">
        <div class="card-body">
            <table id="artistTable" class="table table-bordered table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>#</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Gender</th>
                        <th>Education</th>
                        <th>Work Status</th>
                        <th>Status</th>
                        <th>Created At</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Edit Page -->
<div class="modal fade" id="editCandidateModal" tabindex="-1" aria-labelledby="editCandidateModalTitle"
    aria-hidden="true">
    <div class="modal-dialog modal-lg custom-modal">
        <div class="modal-content">
            <div class="modal-header d-flex justify-content-between align-items-center">
                <h5 class="modal-title" id="editCandidateModalTitle">Edit Candidate</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <form id="editCandidateForm" enctype="multipart/form-data">
                    <input type="hidden" id="editCandidateId" name="candidateId">
                    <ul class="nav nav-tabs mb-3" id="editTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <a class="nav-link active" id="personal-tab" data-bs-toggle="tab" href="#personal"
                                role="tab" aria-controls="personal" aria-selected="true">Personal Detail</a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" id="education-tab" data-bs-toggle="tab" href="#education" role="tab"
                                aria-controls="education" aria-selected="false">Education Details</a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" id="basic-tab" data-bs-toggle="tab" href="#basic" role="tab"
                                aria-controls="basic" aria-selected="false">Basic Details</a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" id="experience-tab" data-bs-toggle="tab" href="#experience" role="tab"
                                aria-controls="experience" aria-selected="false">Work Experience</a>
                        </li>
                    </ul>
                    <div class="tab-content" id="editTabsContent">
                        <div class="tab-pane fade show active" id="personal" role="tabpanel"
                            aria-labelledby="personal-tab">
                            <div class="mb-3">
                                <label for="editName" class="form-label">Name</label>
                                <input type="text" class="form-control" id="editName" name="name" required>
                            </div>
                            <div class="mb-3">
                                <label for="editEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="editEmail" name="email" required>
                            </div>
                            <div class="mb-3">
                                <label for="editDateOfBirth" class="form-label">Date of Birth</label>
                                <input type="date" class="form-control" id="editDateOfBirth" name="dateOfBirth" required>
                            </div>
                            <div class="mb-3">
                                <label for="editGender" class="form-label">Gender</label>
                                <select class="form-control" id="editGender" name="gender">
                                    <option value="">Select Gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="editMobileNo" class="form-label">Mobile No.</label>
                                <input type="tel" class="form-control" id="editMobileNo" name="mobileNo" required>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="basic" role="tabpanel" aria-labelledby="basic-tab">
                            <div class="mb-3">
                                <label for="editWorkStatus" class="form-label">Work Status</label>
                                <select class="form-control" id="editWorkStatus" name="workStatus">
                                    <option value="">Select Work Status</option>
                                    <option value="Fresher">Fresher</option>
                                    <option value="Experienced">Experienced</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Experience</label>
                                <div class="row">
                                    <div class="col-md-6">
                                        <input type="text" class="form-control" id="editExperienceYears"
                                            name="experienceYears" placeholder="Years" min="0">
                                    </div>
                                    <div class="col-md-6">
                                        <input type="text" class="form-control" id="editExperienceMonths"
                                            name="experienceMonths" placeholder="Months" min="0" max="11">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="editLocation" class="form-label">Current Location</label>
                                <input type="text" class="form-control" id="editLocation" name="location">
                            </div>
                            <div class="mb-3">
                                <label for="editSalary" class="form-label">Current/Last Salary</label>
                                <input type="text" class="form-control" id="editSalary" name="salary">
                            </div>
                            <div class="mb-3">
                                <label for="editJoin" class="form-label">Available to Join</label>
                                <input type="text" class="form-control" id="editJoin" name="join">
                            </div>
                        </div>

                        <div class="tab-pane fade" id="experience" role="tabpanel" aria-labelledby="experience-tab">
                            <div class="mb-3">
                                <label for="editWorkInstitution" class="form-label">Current/Previous Institution</label>
                                <input type="text" class="form-control" id="editWorkInstitution" name="workInstitution">
                            </div>
                            <div class="mb-3">
                                <label for="editWorkSubjectSpecialization" class="form-label">Subject Specialization</label>
                                <input type="text" class="form-control" id="editWorkSubjectSpecialization" name="workSubjectSpecialization">
                            </div>
                            <div class="mb-3">
                                <label for="editDesignation" class="form-label">Role/Designation</label>
                                <input type="text" class="form-control" id="editDesignation" name="designation">
                            </div>
                            <div class="mb-3">
                                <label for="editGradesTaught" class="form-label">Grades Taught</label>
                                <input type="text" class="form-control" id="editGradesTaught" name="gradesTaught">
                            </div>
                            <div class="mb-3">
                                <label for="editJobType" class="form-label">Job Type</label>
                                <select class="form-control" id="editJobType" name="jobType">
                                    <option value="">Select Job Type</option>
                                    <option value="Full-Time">Full-Time</option>
                                    <option value="Internship">Internship</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="editAreYouWorking" class="form-label">Are you working in this institute?</label>
                                <select class="form-control" id="editAreYouWorking" name="areYouWorking">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="editJoiningDate" class="form-label">Joining Date</label>
                                    <input type="date" class="form-control" id="editJoiningDate" name="joiningDate">
                                </div>
                                <div class="col-md-6">
                                    <label for="editLeavingDate" class="form-label">Leaving Date</label>
                                    <input type="date" class="form-control" id="editLeavingDate" name="leavingDate">
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="education" role="tabpanel" aria-labelledby="education-tab">
                            <div class="mb-3">
                                <label for="editEducationLevel" class="form-label">Education</label>
                                <select class="form-control" id="editEducationLevel" name="education">
                                    <option value="">Select Education</option>
                                    <option value="Class X">Class X</option>
                                    <option value="Class XII">Class XII</option>
                                    <option value="Graduation">Graduation</option>
                                    <option value="Post Graduation">Post Graduation</option>
                                    <option value="Doctorate">Doctorate</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="editInstitutionName" class="form-label">Institution Name</label>
                                <input type="text" class="form-control" id="editInstitutionName" name="institutionName">
                            </div>
                            <div class="mb-3">
                                <label for="editDegreeName" class="form-label">Degree Name</label>
                                <input type="text" class="form-control" id="editDegreeName" name="degreeName">
                            </div>
                            <div class="mb-3">
                                <label for="editEduSubjectSpecialization" class="form-label">Subject Specialization</label>
                                <input type="text" class="form-control" id="editEduSubjectSpecialization" name="eduSubjectSpecialization">
                            </div>
                            <div class="mb-3">
                                <label for="editYearOfPassout" class="form-label">Year of Passout</label>
                                <input type="text" class="form-control" id="editYearOfPassout" name="yearOfPassout">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-pink">Update Candidate</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- JS dependencies -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

<script>
    $(document).ready(function () {

        // Helper: confirm dialog using SweetAlert2
        function swalConfirm(message, callback) {
            Swal.fire({
                title: 'Confirm',
                text: message,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes'
            }).then((result) => {
                if (result.isConfirmed) callback();
            });
        }

        // Initialize DataTable
        let table = $('#artistTable').DataTable({
            processing: true,
            serverSide: true,
            pageLength: 10,
            lengthMenu: [10, 25, 50, 100],
            scrollY: "400px",
            scrollCollapse: true,
            searching: false,
            ajax: {
                url: '/candidate/getCandidate',
                type: 'POST',
                data: function (d) {
                    d.name = $('#searchName').val();
                    d.email = $('#searchEmail').val();
                    d.gender = $('#searchGender').val();
                    d.education = $('#searchEducation').val();
                    d.work_status = $('#searchWorkStatus').val();
                },
            },
            columns: [
                {
                    data: null,
                    orderable: false,
                    render: (data, type, row, meta) => meta.row + meta.settings._iDisplayStart + 1
                },
                {
                    data: null,
                    render: (data) => data.personalDetails?.name || '-'
                },
                {
                    data: null,
                    render: (data) => data.personalDetails?.email || '-'
                },
                {
                    data: null,
                    render: (data) => data.personalDetails?.gender || '-'
                },
                {
                    data: null,
                    render: (data) => data.educationalDetails?.education || '-'
                },
                {
                    data: null,
                    render: (data) => data.basicDetails?.workStatus || '-'
                },
                {
                    data: null,
                    render: (data, type, row) => {
                        const isActive = row.status === 1;
                        return `
                            <button class="btn btn-sm toggleStatusBtn ${isActive ? 'btn-success' : 'btn-secondary'}" 
                                data-id="${row._id}" 
                                data-status="${row.status}">
                                ${isActive ? 'Active' : 'Inactive'}
                            </button>
                        `;
                    }
                },
                {
                    data: 'createdAt',
                    render: (data) => data ? new Date(data).toLocaleString() : '-'
                },
                {
                    data: null,
                    orderable: false,
                    render: (data, type, row) => `
                        <button class="btn btn-sm btn-primary me-2 editUserBtn" data-id='${row._id}'>
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-danger delUserBtn" data-id='${row._id}'>
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    `
                }
            ],
            columnDefs: [
                { orderable: false, targets: [0, 8] }
            ]
        });

        // Toggle Status Button Click
        $('#artistTable').on('click', '.toggleStatusBtn', function () {
            const candidateId = $(this).data('id');
            const currentStatus = $(this).data('status');
            const newStatus = currentStatus === 1 ? 2 : 1;

            $.ajax({
                url: '/candidate/updateCandidateStatus/' + candidateId,
                type: 'PATCH',
                data: { status: newStatus },
                dataType: "json",
                success: function (res) {
                    toastr.success('Status updated successfully!');
                    table.ajax.reload(null, false);
                },
                error: function (xhr, status, error) {
                    console.error("Error updating status:", status, error, xhr);
                    toastr.error('Failed to update status.', 'Error');
                }
            });
        });

        // Edit Button Click
        $('#artistTable').on('click', '.editUserBtn', function () {
            const id = $(this).data('id');
            $('#editCandidateModal').modal('show');
            $('#editCandidateForm')[0].reset(); // Reset form inputs
            $('#editCandidateId').val(id);

            // Fetch candidate data
            $.get(`/candidate/getCandidateById/${id}`, function (data) {
                const candidate = data.candidate;

                // Personal Details
                $('#editName').val(candidate.personalDetails?.name || '');
                $('#editEmail').val(candidate.personalDetails?.email || '');
                if (candidate.personalDetails?.dob) {
                    $('#editDateOfBirth').val(moment(candidate.personalDetails.dob).format('YYYY-MM-DD'));
                }
                $('#editGender').val(candidate.personalDetails?.gender || '');
                $('#editMobileNo').val(candidate.personalDetails?.mobile || '');

                // Basic Details
                $('#editWorkStatus').val(candidate.basicDetails?.workStatus || '');
                $('#editExperienceYears').val(candidate.basicDetails?.experience?.year || '');
                $('#editExperienceMonths').val(candidate.basicDetails?.experience?.month || '');
                $('#editLocation').val(candidate.basicDetails?.currentLocation || '');
                $('#editSalary').val(candidate.basicDetails?.currentSalary || '');
                $('#editJoin').val(candidate.basicDetails?.availableToJoin || '');

                // Work Experience
                $('#editWorkInstitution').val(candidate.workExperience?.institutionName || '');
                $('#editWorkSubjectSpecialization').val(candidate.workExperience?.subjectSpecialization || '');
                $('#editDesignation').val(candidate.workExperience?.designation || '');
                $('#editGradesTaught').val(candidate.workExperience?.gradesTaught || '');
                $('#editJobType').val(candidate.workExperience?.jobType || '');
                $('#editAreYouWorking').val(candidate.workExperience?.areYouWorking || '');
                if (candidate.workExperience?.joiningDate) {
                    $('#editJoiningDate').val(moment(candidate.workExperience.joiningDate).format('YYYY-MM-DD'));
                }
                if (candidate.workExperience?.leavingDate) {
                    $('#editLeavingDate').val(moment(candidate.workExperience.leavingDate).format('YYYY-MM-DD'));
                }

                // Education
                $('#editEducationLevel').val(candidate.educationalDetails?.education || '');
                $('#editInstitutionName').val(candidate.educationalDetails?.institutionName || '');
                $('#editDegreeName').val(candidate.educationalDetails?.degreeName || '');
                $('#editEduSubjectSpecialization').val(candidate.educationalDetails?.subjectSpecialization || '');
                $('#editYearOfPassout').val(candidate.educationalDetails?.yearOfPassout || '');
            }).fail(function(xhr, status, error) {
                console.error("Error fetching candidate data:", error);
                toastr.error('Failed to load candidate data.', 'Error');
            });
        });

        // Delete Button Click
        $('#artistTable').on('click', '.delUserBtn', function () {
            const candidateId = $(this).data('id');

            swalConfirm('Are you sure you want to delete this Candidate?', function () {
                $.ajax({
                    url: '/candidate/deleteCandidate/' + candidateId,
                    type: 'PATCH',
                    dataType: 'json',
                    success: function (response) {
                        table.ajax.reload();
                        if (response.success) {
                            toastr.success(response.message, 'Success');
                        } else {
                            toastr.error(response.message, 'Error');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Error deleting candidate:", status, error, xhr);
                        toastr.error('Error deleting candidate.', 'Error');
                    }
                });
            });
        });

        // Search Button Click
        $('#searchBtn').on('click', function () {
            table.ajax.reload();
        });

        // Reset Button Click
        $('#resetBtn').on('click', function () {
            $('#searchName').val('');
            $('#searchEmail').val('');
            $('#searchGender').val('');
            $('#searchEducation').val('');
            $('#searchWorkStatus').val('');
            table.ajax.reload();
        });

        // Edit Candidate Form Submit
        $('#editCandidateForm').on('submit', function (e) {
            e.preventDefault();
            
            const candidateId = $('#editCandidateId').val();
            
            if (!candidateId) {
                toastr.error('Candidate ID is missing.', 'Error');
                return;
            }

            // Prepare form data
            const formData = {
                candidateId: candidateId,
                personalDetails: {
                    name: $('#editName').val(),
                    email: $('#editEmail').val(),
                    dob: $('#editDateOfBirth').val(),
                    gender: $('#editGender').val(),
                    mobile: $('#editMobileNo').val()
                },
                basicDetails: {
                    workStatus: $('#editWorkStatus').val(),
                    experience: {
                        year: $('#editExperienceYears').val(),
                        month: $('#editExperienceMonths').val()
                    },
                    currentLocation: $('#editLocation').val(),
                    currentSalary: $('#editSalary').val(),
                    availableToJoin: $('#editJoin').val()
                },
                workExperience: {
                    institutionName: $('#editWorkInstitution').val(),
                    subjectSpecialization: $('#editWorkSubjectSpecialization').val(),
                    designation: $('#editDesignation').val(),
                    gradesTaught: $('#editGradesTaught').val(),
                    jobType: $('#editJobType').val(),
                    areYouWorking: $('#editAreYouWorking').val(),
                    joiningDate: $('#editJoiningDate').val(),
                    leavingDate: $('#editLeavingDate').val()
                },
                educationalDetails: {
                    education: $('#editEducationLevel').val(),
                    institutionName: $('#editInstitutionName').val(),
                    degreeName: $('#editDegreeName').val(),
                    subjectSpecialization: $('#editEduSubjectSpecialization').val(),
                    yearOfPassout: $('#editYearOfPassout').val()
                }
            };

            // Submit form data
            $.ajax({
                url: '/candidate/updateCandidateProfile',
                type: 'PATCH',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function (res) {
                    if (res.success) {
                        toastr.success('Candidate updated successfully!');
                        $('#editCandidateModal').modal('hide');
                        table.ajax.reload(null, false);
                    } else {
                        toastr.error(res.message || 'Failed to update candidate.');
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Error updating candidate:", error, xhr.responseText);
                    toastr.error('Error updating candidate.');
                }
            });
        });

        // Initialize toastr options
        toastr.options = {
            "closeButton": true,
            "debug": false,
            "newestOnTop": false,
            "progressBar": true,
            "positionClass": "toast-top-right",
            "preventDuplicates": false,
            "onclick": null,
            "showDuration": "300",
            "hideDuration": "1000",
            "timeOut": "5000",
            "extendedTimeOut": "1000",
            "showEasing": "swing",
            "hideEasing": "linear",
            "showMethod": "fadeIn",
            "hideMethod": "fadeOut"
        };
    });
</script>